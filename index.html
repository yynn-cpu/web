<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤§ç¬¨æ¡¶å®ç›˜æ‰«æå™¨ - Google Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&family=Roboto:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            --g-blue: #1a73e8;
            --g-red: #ea4335;
            --g-green: #34a853;
            --g-grey: #5f6368;
            --white: #ffffff;
            --border: #e0e0e0;
        }

        body {
            font-family: 'Google Sans', Roboto, Arial, sans-serif;
            background-color: #f8f9fa;
            color: #202124;
            margin: 0;
            padding: 24px;
        }

        .header-container {
            max-width: 1100px;
            margin: 0 auto 24px auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-container h1 {
            font-size: 22px;
            font-weight: 400;
            color: var(--g-grey);
            margin: 0;
        }

        .btn-scan {
            background-color: var(--g-blue);
            color: white;
            border: none;
            padding: 10px 24px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            box-shadow: 0 1px 2px 0 rgba(60,64,67,0.3), 0 1px 3px 1px rgba(60,64,67,0.15);
            transition: background 0.2s;
        }

        .btn-scan:hover { background-color: #1765cc; }
        .btn-scan:disabled { background-color: #bdc1c6; cursor: not-allowed; }

        .main-card {
            max-width: 1100px;
            margin: 0 auto;
            background: var(--white);
            border: 1px solid var(--border);
            border-radius: 8px;
            overflow: hidden;
        }

        .progress-container {
            height: 4px;
            background: #e8eaed;
            width: 100%;
        }

        #progress-bar {
            height: 100%;
            width: 0%;
            background: var(--g-blue);
            transition: width 0.3s;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px;
            font-size: 14px;
            font-weight: 500;
            color: var(--g-grey);
            border-bottom: 1px solid var(--border);
            background: #fafafa;
        }

        td {
            padding: 16px;
            border-bottom: 1px solid #f1f3f4;
            font-size: 14px;
            color: #3c4043;
        }

        .symbol-name { font-weight: 700; color: var(--g-blue); }
        .strat-badge { 
            background: #f1f3f4; 
            padding: 4px 8px; 
            border-radius: 4px; 
            font-size: 12px; 
            color: var(--g-grey);
        }
        .text-green { color: var(--g-green); font-weight: 500; }
        .text-red { color: var(--g-red); font-weight: 500; }
        .status-text { font-size: 13px; color: var(--g-grey); margin-left: 10px; }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>ğŸ“Š å®ç›˜æ‰«æå·¥ä½œç«™ <span id="status" class="status-text">å°±ç»ª</span></h1>
        <button class="btn-scan" id="scanBtn" onclick="startScan()">ç«‹å³æ‰«æ</button>
    </div>

    <div class="main-card">
        <div class="progress-container"><div id="progress-bar"></div></div>
        <table>
            <thead>
                <tr>
                    <th>äº¤æ˜“å¯¹</th>
                    <th>å‘½ä¸­ç­–ç•¥</th>
                    <th>ç°ä»· / å…¥åœº</th>
                    <th>å½“å‰åç¦»</th>
                    <th>å†å²èƒœç‡</th>
                    <th>å†å²æ€»ç›ˆäº</th>
                </tr>
            </thead>
            <tbody id="resBody">
                <tr><td colspan="6" style="text-align:center; padding:60px; color:#9aa0a6;">ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®ï¼Œå¼€å§‹å…¨å¸‚åœºæ‰«æåˆ†æ...</td></tr>
            </tbody>
        </table>
    </div>

<script>
    // æ ¸å¿ƒå‚æ•° (ä¸ä½ çš„ Python ä»£ç å®Œå…¨ä¸€è‡´)
    const TP = 0.02;
    const INVEST = 20;
    const LEVERAGE = 20;
    const MAX_DEVIATION = 0.02;      // åç¦»ä¸Šé™ +2%
    const MAX_PULLUP = -0.20;        // åç¦»ä¸‹é™ -20%
    const PROXY_URL = "https://bitter-dream-fe9c.2xiaxiaxia.workers.dev"; // ä½ çš„ä¸­è½¬åœ°å€

    // ç­–ç•¥é€»è¾‘å®šä¹‰
    const STRATEGIES = [
        {
            name: "BIG_GREEN_RED_5%",
            check: (df) => {
                const p2 = df[df.length-3], p1 = df[df.length-2];
                return (p2.c >= p2.o * 1.05 && p1.c < p1.o);
            }
        },
        {
            name: "LONG_SHADOW_REVERSE",
            check: (df) => {
                const p2 = df[df.length-3], p1 = df[df.length-2];
                return (p1.c >= p1.o * 1.05 && p2.o < p1.c);
            }
        },
        {
            name: "SMALL_BODY_SAFE",
            check: (df) => {
                const p2 = df[df.length-3], p1 = df[df.length-2];
                const body = Math.abs(p1.c - p1.o);
                const range = p1.h - p1.l;
                return (p2.c >= p2.o * 1.05 && body < (range * 0.3) && p1.c < p1.o);
            }
        }
    ];

    async function startScan() {
        const btn = document.getElementById('scanBtn');
        const status = document.getElementById('status');
        const progress = document.getElementById('progress-bar');
        const tbody = document.getElementById('resBody');
        
        btn.disabled = true;
        tbody.innerHTML = "";
        
        try {
            status.innerText = "ğŸ” æ­£åœ¨è¿æ¥å¸å®‰ API...";
            // 1. è·å–æ‰€æœ‰åˆçº¦äº¤æ˜“å¯¹
            const infoRes = await fetch(`${PROXY_URL}/fapi/v1/exchangeInfo`);
            const info = await infoRes.json();
            const symbols = info.symbols
                .filter(s => s.contractType === "PERPETUAL" && s.quoteAsset === "USDT")
                .map(s => s.symbol);
            
            let foundCount = 0;

            // 2. éå†æ‰«æ
            for (let i = 0; i < symbols.length; i++) {
                const sym = symbols[i];
                // æ›´æ–°è¿›åº¦æ¡
                progress.style.width = ((i / symbols.length) * 100) + "%";
                status.innerText = `æ­£åœ¨æ‰«æ: ${sym} (${i}/${symbols.length})`;

                try {
                    // è·å– K çº¿æ•°æ® (1d, 100æ¡è¶³ä»¥å›æµ‹)
                    const kRes = await fetch(`${PROXY_URL}/fapi/v1/klines?symbol=${sym}&interval=1d&limit=100`);
                    const rawK = await kRes.json();
                    
                    // æ ¼å¼åŒ–æ•°æ®å¹¶å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—ç±»å‹
                    const df = rawK.map(k => ({ 
                        o: parseFloat(k[1]), h: parseFloat(k[2]), l: parseFloat(k[3]), c: parseFloat(k[4]) 
                    }));

                    if (df.length < 10) continue;

                    const entryPrice = df[df.length - 1].o; // ä»Šæ—¥å¼€ç›˜ä»·
                    const currentPrice = df[df.length - 1].c; // å½“å‰ç°ä»·
                    const deviation = (entryPrice - currentPrice) / entryPrice;

                    // ç­–ç•¥è¿‡æ»¤ï¼šåç¦»è¿‡å¤§æˆ–è¿‡å°ç›´æ¥è·³è¿‡
                    if (deviation >= MAX_DEVIATION || deviation <= MAX_PULLUP) continue;

                    // æ£€æŸ¥æ‰€æœ‰ç­–ç•¥
                    for (let strat of STRATEGIES) {
                        if (strat.check(df)) {
                            // æ‰§è¡Œå³æ—¶å›æµ‹é€»è¾‘
                            let trades = 0, wins = 0, totalProfit = 0;
                            
                            for (let j = 10; j < df.length - 1; j++) {
                                if (strat.check(df.slice(0, j + 1))) {
                                    trades++;
                                    let entry = df[j].o;
                                    let targetTp = entry * (1 - TP);
                                    
                                    // æ¨¡æ‹Ÿæ¬¡æ—¥èµ°åŠ¿
                                    if (df[j+1].l <= targetTp) {
                                        wins++;
                                        totalProfit += (TP * INVEST * LEVERAGE);
                                    } else {
                                        totalProfit += ((entry - df[j+1].c) / entry * INVEST * LEVERAGE);
                                    }
                                }
                            }

                            if (trades > 0) {
                                foundCount++;
                                tbody.innerHTML += `
                                    <tr>
                                        <td><span class="symbol-name">${sym}</span></td>
                                        <td><span class="strat-badge">${strat.name}</span></td>
                                        <td>${currentPrice.toFixed(4)} / ${entryPrice.toFixed(4)}</td>
                                        <td>${(deviation * 100).toFixed(2)}%</td>
                                        <td class="text-green">${((wins/trades)*100).toFixed(1)}%</td>
                                        <td class="${totalProfit >= 0 ? 'text-green' : 'text-red'}">${totalProfit.toFixed(2)} USDT</td>
                                    </tr>
                                `;
                            }
                        }
                    }
                } catch (err) { console.warn(`è·³è¿‡ ${sym}: æ•°æ®è¯·æ±‚å¤±è´¥`); }
            }
            
            status.innerText = foundCount > 0 ? `âœ… æ‰«æå®Œæˆï¼Œå‘ç° ${foundCount} ä¸ªä¿¡å·` : "ğŸµ æ‰«æå®Œæˆï¼Œæš‚æ— ç¬¦åˆä¿¡å·";
            if(foundCount === 0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:60px; color:#9aa0a6;">å½“å‰è¡Œæƒ…æœªè§¦å‘ä»»ä½•ç­–ç•¥ä¿¡å·</td></tr>';

        } catch (e) {
            status.innerText = "âŒ æ‰«æå‡ºé”™: è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–ä¸­è½¬ç«™";
            console.error(e);
        }
        
        btn.disabled = false;
        progress.style.width = "0%";
    }
</script>
</body>
</html>
