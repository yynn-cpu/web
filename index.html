<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¤§ç¬¨æ¡¶å®ç›˜æ‰«æå™¨ - æ··åˆåŠ¨åŠ›ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --g-blue: #1a73e8; --g-green: #34a853; --g-red: #ea4335; --g-grey: #5f6368; }
        body { font-family: 'Google Sans', sans-serif; background: #f8f9fa; color: #202124; margin: 0; padding: 20px; }
        .header { max-width: 1200px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: center; }
        .card { max-width: 1200px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(60,64,67,0.3); overflow: hidden; }
        .status-bar { padding: 10px 20px; background: #e8f0fe; color: var(--g-blue); font-size: 13px; display: flex; align-items: center; gap: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #fafafa; border-bottom: 1px solid #eee; color: var(--g-grey); font-size: 13px; }
        td { padding: 15px; border-bottom: 1px solid #f1f3f4; font-size: 14px; }
        .symbol { font-weight: bold; color: var(--g-blue); }
        .tag { font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .tag-hit { background: #e6f4ea; color: var(--g-green); border: 1px solid var(--g-green); }
        .tag-wait { background: #f1f3f4; color: #999; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="font-size: 22px; color: var(--g-grey); margin: 0;">ğŸ“¡ ç­–ç•¥å·¥ä½œç«™ (REST + WebSocket)</h1>
        <div class="status-bar"><span id="status">æ­£åœ¨åˆå§‹åŒ–å†å² K çº¿...</span></div>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>äº¤æ˜“å¯¹</th>
                    <th>ç°ä»·/å¼€ç›˜</th>
                    <th>åç¦»åº¦</th>
                    <th>BIG_GREEN_RED</th>
                    <th>LONG_SHADOW</th>
                    <th>SMALL_BODY</th>
                </tr>
            </thead>
            <tbody id="resBody">
                <tr><td colspan="6" style="text-align:center; padding:60px; color:#999;">æ­£åœ¨åŠ è½½åˆå§‹æ•°æ®å¹¶å»ºç«‹å®æ—¶è¿æ¥...</td></tr>
            </tbody>
        </table>
    </div>

<script>
    const resBody = document.getElementById('resBody');
    const status = document.getElementById('status');
    
    // 1. å­˜å‚¨æ¯ä¸ªå¸ç§çš„å†å² K çº¿ (å†…å­˜æ•°æ®åº“)
    const klineDB = {}; 
    const MAX_DEVIATION = 0.02, MAX_PULLUP = -0.20;

    // ä½¿ç”¨å…¬å…±è·¨åŸŸä¸­è½¬è§£å†³ REST API æŠ¥é”™
    const PROXY = "https://api.allorigins.win/raw?url=";

    // ç­–ç•¥é€»è¾‘ (å®Œå…¨ç¿»è¯‘è‡ªä½ çš„ Python ä»£ç )
    const is_BIG_GREEN_RED = (df) => {
        if (df.length < 3) return false;
        const prev2 = df[df.length-3], prev1 = df[df.length-2];
        return (prev2.c >= prev2.o * 1.05 && prev1.c < prev1.o);
    };

    const is_LONG_SHADOW = (df) => {
        if (df.length < 3) return false;
        const prev2 = df[df.length-3], prev1 = df[df.length-2];
        return (prev1.c >= prev1.o * 1.05 && prev2.o < prev1.c);
    };

    const is_SMALL_BODY = (df) => {
        if (df.length < 3) return false;
        const prev2 = df[df.length-3], prev1 = df[df.length-2];
        const body = Math.abs(prev1.c - prev1.o);
        const range = prev1.h - prev1.l;
        return (prev2.c >= prev2.o * 1.05 && body < range * 0.3 && prev1.c < prev1.o);
    };

    // ç¬¬ä¸€æ­¥ï¼šåˆå§‹åŒ–æŠ“å–æœ€è¿‘ 5 æ ¹ K çº¿
    async function initKlines() {
        try {
            status.innerText = "Step 1: æ­£åœ¨è·å–æ‰€æœ‰åˆçº¦åˆ—è¡¨...";
            const exchangeRes = await fetch(PROXY + encodeURIComponent("https://fapi.binance.com/fapi/v1/exchangeInfo"));
            const info = await exchangeRes.json();
            const symbols = info.symbols.filter(s => s.quoteAsset === "USDT" && s.contractType === "PERPETUAL").slice(0, 100); // æ¼”ç¤ºå…ˆå–å‰100ä¸ª

            status.innerText = `Step 2: æ­£åœ¨å¹¶è¡ŒæŠ“å– ${symbols.length} ä¸ªå¸ç§çš„å†å² K çº¿...`;
            
            // å¹¶å‘è¯·æ±‚å†å²æ•°æ®
            await Promise.all(symbols.map(async (s) => {
                try {
                    const kUrl = `https://fapi.binance.com/fapi/v1/klines?symbol=${s.symbol}&interval=1d&limit=5`;
                    const kRes = await fetch(PROXY + encodeURIComponent(kUrl));
                    const data = await kRes.json();
                    klineDB[s.symbol] = data.map(k => ({ o: +k[1], h: +k[2], l: +k[3], c: +k[4] }));
                } catch (e) {}
            }));

            startWebSocket();
        } catch (err) {
            status.innerText = "åˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–åˆ·æ–°é¡µé¢";
        }
    }

    // ç¬¬äºŒæ­¥ï¼šå¯åŠ¨ WebSocket è¿›è¡Œå®æ—¶æ‹¼æ¥å’Œç­–ç•¥åˆ¤æ–­
    function startWebSocket() {
        status.innerText = "Step 3: å®æ—¶è¿æ¥ä¸­...";
        const socket = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');

        socket.onmessage = (event) => {
            const tickers = JSON.parse(event.data);
            
            // ç­›é€‰æœ‰å†å²æ•°æ®çš„å¸ç§
            const results = tickers.filter(t => klineDB[t.s]).map(t => {
                const sym = t.s;
                const curPrice = parseFloat(t.c);
                const openPrice = parseFloat(t.o);
                const dev = (openPrice - curPrice) / openPrice;

                // ã€å…³é”®æ­¥éª¤ã€‘ï¼šç”¨ WebSocket æ¨é€çš„ä»·æ ¼æ›´æ–° K çº¿æ•°ç»„ä¸­æœ€åä¸€æ ¹(ä»Šå¤©)çš„æ”¶ç›˜ä»·
                const df = [...klineDB[sym]];
                df[df.length - 1].c = curPrice;
                df[df.length - 1].h = parseFloat(t.h);
                df[df.length - 1].l = parseFloat(t.l);

                // åªæœ‰åç¦»åº¦ç¬¦åˆæ‰æ˜¾ç¤º
                if (dev >= MAX_DEVIATION || dev <= MAX_PULLUP) return null;

                return {
                    s: sym,
                    c: curPrice,
                    o: openPrice,
                    d: (dev * 100).toFixed(2),
                    s1: is_BIG_GREEN_RED(df),
                    s2: is_LONG_SHADOW(df),
                    s3: is_SMALL_BODY(df)
                };
            }).filter(x => x && (x.s1 || x.s2 || x.s3)); // åªè¦æœ‰ä¸€ä¸ªç­–ç•¥å‘½ä¸­å°±æ˜¾ç¤º

            updateUI(results);
        };
    }

    function updateUI(data) {
        if (data.length === 0) {
            resBody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:60px; color:#999;">æ­£åœ¨ç›‘å¬ä¿¡å·ä¸­ï¼ˆç­–ç•¥é€»è¾‘å·²æ¿€æ´»ï¼‰...</td></tr>';
            return;
        }
        status.innerText = `ç›‘æ§ä¸­ - å‘ç° ${data.length} ä¸ªç¬¦åˆç­–ç•¥çš„æ´»è·ƒä¿¡å·`;
        resBody.innerHTML = data.map(item => `
            <tr>
                <td><span class="symbol">${item.s}</span></td>
                <td>${item.c.toFixed(4)} / ${item.o.toFixed(4)}</td>
                <td style="color:${item.d > 0 ? 'var(--g-red)' : 'var(--g-green)'}">${item.d}%</td>
                <td><span class="tag ${item.s1 ? 'tag-hit' : 'tag-wait'}">${item.s1 ? 'å‘½ä¸­' : '-'}</span></td>
                <td><span class="tag ${item.s2 ? 'tag-hit' : 'tag-wait'}">${item.s2 ? 'å‘½ä¸­' : '-'}</span></td>
                <td><span class="tag ${item.s3 ? 'tag-hit' : 'tag-wait'}">${item.s3 ? 'å‘½ä¸­' : '-'}</span></td>
            </tr>
        `).join('');
    }

    // å¯åŠ¨ç¨‹åº
    initKlines();
</script>
</body>
</html>
