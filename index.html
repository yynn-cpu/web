<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¤§ç¬¨æ¡¶å®ç›˜å…¨èƒ½æ‰«æå™¨ - ç­–ç•¥ 1:1 ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --g-blue: #1a73e8; --g-green: #34a853; --g-red: #ea4335; --g-grey: #5f6368; }
        body { font-family: 'Google Sans', sans-serif; background: #f8f9fa; margin: 0; padding: 20px; color: #202124; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .card { background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(60,64,67,0.3); overflow: hidden; }
        .status-bar { padding: 12px 20px; background: #e8f0fe; color: var(--g-blue); font-size: 13px; font-weight: 500; border-bottom: 1px solid #d2e3fc; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #fafafa; border-bottom: 1px solid #eee; color: var(--g-grey); font-size: 13px; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #f1f3f4; font-size: 14px; }
        .symbol { font-weight: bold; color: var(--g-blue); }
        .strat-label { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-right: 4px; border: 1px solid #eee; }
        .hit { background: #e6f4ea; color: var(--g-green); border-color: var(--g-green); }
        .profit-pos { color: var(--g-green); font-weight: bold; }
        .profit-neg { color: var(--g-red); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="header">
        <h1>ğŸ“Š ç­–ç•¥å®ç›˜æ‰«æå™¨ <small style="font-size: 12px; color: #999;">(çº¯ç½‘é¡µ Native ç‰ˆ)</small></h1>
        <div id="loading-hint" style="color: var(--g-grey); font-size: 14px;">åˆå§‹åŒ–ä¸­...</div>
    </div>

    <div class="card">
        <div class="status-bar" id="status">æ­£åœ¨åŒæ­¥å¸å®‰åˆçº¦æ•°æ®...</div>
        <table id="resultTable">
            <thead>
                <tr>
                    <th>åˆçº¦å¯¹</th>
                    <th>å‘½ä¸­ç­–ç•¥</th>
                    <th>ç°ä»·/å…¥åœº</th>
                    <th>åç¦»åº¦</th>
                    <th>å†å²å›æµ‹ (èƒœç‡/ç›ˆäº)</th>
                </tr>
            </thead>
            <tbody id="resBody">
                <tr><td colspan="5" style="text-align:center; padding:100px; color:#999;">
                    æ­£åœ¨ç»•è¿‡ CORS é™åˆ¶åŒæ­¥å†å² K çº¿ï¼Œè¯·ç¨å...
                </td></tr>
            </tbody>
        </table>
    </div>
</div>

<script>
    // --- é…ç½®ä¸ä½ çš„ Python ä¿æŒ 1:1 ---
    const TP = 0.02, INVEST = 20, LEVERAGE = 20;
    const MAX_DEVIATION = 0.02, MAX_PULLUP = -0.20;

    // --- æ ¸å¿ƒæ•°æ®åº“ ---
    const symbolData = {};

    // --- ç­–ç•¥åˆ¤å®š (å®Œå…¨è¿˜åŸä½ çš„ iloc[-3], iloc[-2]) ---
    const checkStrategies = (df) => {
        if (df.length < 3) return [];
        const prev2 = df[df.length - 3];
        const prev1 = df[df.length - 2];
        const hits = [];

        // 1. BIG_GREEN_RED_5%
        if (prev2.c >= prev2.o * 1.05 && prev1.c < prev1.o) hits.push("å¤§é˜³åè°ƒ");

        // 2. NEW1_LONG_SHADOW_REVERSE
        if (prev1.c >= prev1.o * 1.05 && prev2.o < prev1.c) hits.push("é•¿å½±åè½¬");

        // 3. NEW5_SMALL_BODY_REVERSE_SAFE
        const body = Math.abs(prev1.c - prev1.o);
        const range = prev1.h - prev1.l;
        if (prev2.c >= prev2.o * 1.05 && body < range * 0.3 && prev1.c < prev1.o) hits.push("ç¼©é‡å®‰å…¨");

        return hits;
    };

    // --- ç½‘é¡µç«¯å›æµ‹å¼•æ“ ---
    function backtest(df, name) {
        let trades = 0, wins = 0, totalP = 0;
        // æ¨¡æ‹Ÿ Python çš„ range(2, n-1)
        for (let i = 2; i < df.length - 1; i++) {
            const subDf = df.slice(0, i + 1);
            // ç®€å•æ¨¡æ‹Ÿç­–ç•¥åŒ¹é…
            const hits = checkStrategies(subDf);
            if (hits.length > 0) {
                trades++;
                const entry = df[i].o;
                const tpPrice = entry * (1 - TP);
                // æ¨¡æ‹ŸæŒä»“
                if (df[i+1].l <= tpPrice) {
                    wins++;
                    totalP += (TP * INVEST * LEVERAGE);
                } else {
                    totalP += ((entry - df[i+1].c) / entry * INVEST * LEVERAGE);
                }
            }
        }
        return trades > 0 ? { wr: (wins/trades*100).toFixed(1), p: totalP.toFixed(2) } : null;
    }

    // --- æ ¸å¿ƒï¼šæ— ä»£ç†ç›´è¿ (åˆ©ç”¨ WebSocket è¡¥å…¨æ•°æ®) ---
    async function startEngine() {
        const status = document.getElementById('status');
        const resBody = document.getElementById('resBody');

        try {
            // 1. è·å–åˆçº¦åˆ—è¡¨ (ä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„è·¨åŸŸå·¥å…·ï¼Œè¿™ä¸ªé€šå¸¸æ¯” Worker ç¨³)
            const exchangeUrl = "https://api.allorigins.win/raw?url=" + encodeURIComponent("https://fapi.binance.com/fapi/v1/exchangeInfo");
            const response = await fetch(exchangeUrl);
            const info = await response.json();
            const symbols = info.symbols.filter(s => s.quoteAsset === "USDT" && s.contractType === "PERPETUAL").slice(0, 50); // æ¼”ç¤ºå…ˆåŠ è½½å‰50ä¸ªï¼Œé˜²æ­¢å µå¡

            status.innerText = `æ­£åœ¨æŠ“å– ${symbols.length} ä¸ªåˆçº¦çš„å†å²æ•°æ®...`;

            for (const s of symbols) {
                const kUrl = `https://api.allorigins.win/raw?url=` + encodeURIComponent(`https://fapi.binance.com/fapi/v1/klines?symbol=${s.symbol}&interval=1d&limit=100`);
                try {
                    const kRes = await fetch(kUrl);
                    const kData = await kRes.json();
                    symbolData[s.symbol] = kData.map(k => ({ o: +k[1], h: +k[2], l: +k[3], c: +k[4] }));
                } catch(e) {}
            }

            // 2. å¯åŠ¨å®æ—¶ç›‘æ§
            const ws = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');
            ws.onmessage = (e) => {
                const tickers = JSON.parse(e.data);
                let html = "";

                tickers.forEach(t => {
                    const df = symbolData[t.s];
                    if (!df) return;

                    const curPrice = parseFloat(t.c);
                    const openPrice = parseFloat(t.o);
                    const dev = (openPrice - curPrice) / openPrice;

                    // åç¦»è¿‡æ»¤
                    if (dev >= MAX_DEVIATION || dev <= MAX_PULLUP) return;

                    // æ‹¼æ¥å½“å‰ä»·æ ¼åˆ°å†å²ä¸­è¿›è¡Œåˆ¤å®š
                    const tempDf = [...df];
                    tempDf[tempDf.length - 1].c = curPrice; // æ›´æ–°ä»Šæ—¥æ”¶ç›˜

                    const hits = checkStrategies(tempDf);
                    if (hits.length > 0) {
                        const stats = backtest(tempDf);
                        html += `
                            <tr>
                                <td><span class="symbol">${t.s}</span></td>
                                <td>${hits.map(h => `<span class="strat-label hit">${h}</span>`).join('')}</td>
                                <td>${curPrice.toFixed(4)} / ${openPrice.toFixed(4)}</td>
                                <td style="color:${dev > 0 ? 'var(--g-green)' : 'var(--g-red)'}">${(dev*100).toFixed(2)}%</td>
                                <td><span class="winrate-tag">${stats ? stats.wr : 0}%</span> / <span class="${stats && stats.p > 0 ? 'profit-pos' : 'profit-neg'}">${stats ? stats.p : 0} USDT</span></td>
                            </tr>
                        `;
                    }
                });

                if (html) {
                    resBody.innerHTML = html;
                    status.innerText = "ğŸš€ æ‰«æä¸­ï¼šå‘ç°ç­–ç•¥ä¿¡å·ï¼";
                } else {
                    resBody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:100px; color:#999;">å…¨å¸‚åœºæ‰«æä¸­ï¼Œæš‚æ— ç¬¦åˆ iloc[-3] & iloc[-2] çš„ç­–ç•¥ä¿¡å·...</td></tr>';
                    status.innerText = "ğŸ“¡ å®æ—¶æ‰«æä¸­ï¼šæš‚æ— ä¿¡å·";
                }
            };

        } catch (err) {
            status.innerText = "è¿æ¥å¤±è´¥ï¼Œè¯·ç¡®ä¿ç½‘ç»œå¯ä»¥è®¿é—®å¸å®‰ä¸”åˆ·æ–°é‡è¯•";
        }
    }

    startEngine();
</script>
</body>
</html>
