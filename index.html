<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å¤§ç¬¨æ¡¶å®ç›˜å…¨èƒ½æ‰«æå™¨ - ç­–ç•¥å¢å¼ºç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --g-blue: #1a73e8; --g-green: #34a853; --g-red: #ea4335; --g-grey: #5f6368; }
        body { font-family: 'Google Sans', sans-serif; background: #f8f9fa; color: #202124; padding: 20px; }
        .header { max-width: 1100px; margin: 0 auto 20px; display: flex; justify-content: space-between; align-items: center; }
        .card { max-width: 1100px; margin: 0 auto; background: #fff; border-radius: 8px; box-shadow: 0 1px 3px rgba(60,64,67,0.3); overflow: hidden; }
        .status-bar { padding: 10px 20px; background: #e8f0fe; color: var(--g-blue); font-size: 13px; display: flex; align-items: center; gap: 10px; }
        table { width: 100%; border-collapse: collapse; }
        th { text-align: left; padding: 15px; background: #fafafa; border-bottom: 1px solid #eee; color: var(--g-grey); font-size: 13px; }
        td { padding: 15px; border-bottom: 1px solid #f1f3f4; font-size: 14px; }
        .symbol { font-weight: bold; color: var(--g-blue); }
        .winrate { color: var(--g-green); font-weight: bold; }
        .strat-label { font-size: 11px; background: #f1f3f4; padding: 2px 6px; border-radius: 4px; color: #555; margin-right: 5px; }
    </style>
</head>
<body>

    <div class="header">
        <h1 style="font-size: 22px; color: var(--g-grey); margin: 0;">ğŸš€ ç­–ç•¥æ‰«æ + å†å²å›æµ‹çœ‹æ¿</h1>
        <div class="status-bar"><span id="status">æ­£åœ¨åŒæ­¥å…¨åœºæ•°æ®...</span></div>
    </div>

    <div class="card">
        <table>
            <thead>
                <tr>
                    <th>äº¤æ˜“å¯¹</th>
                    <th>å‘½ä¸­ç­–ç•¥</th>
                    <th>ç°ä»·/å…¥åœº</th>
                    <th>24h æ¶¨å¹…</th>
                    <th>å†å²èƒœç‡</th>
                    <th>é¢„è®¡ç›ˆäº (20x)</th>
                </tr>
            </thead>
            <tbody id="resBody">
                <tr><td colspan="6" style="text-align:center; padding:60px; color:#999;">æ­£åœ¨å®æ—¶æ•æ‰å¼ºåŠ›ä¿¡å·å¹¶è¿›è¡Œå›æµ‹åˆ†æ...</td></tr>
            </tbody>
        </table>
    </div>

<script>
    // ä½ çš„ Python æ ¸å¿ƒå‚æ•°
    const TP = 0.02, INVEST = 20, LEVERAGE = 20;
    
    // å…¬å…±è·¨åŸŸä¸­è½¬ï¼ˆè§£å†³ä½ æˆªå›¾é‡Œçš„ CORS æŠ¥é”™ï¼‰
    const CORS_PROXY = "https://api.allorigins.win/raw?url=";

    // 1. ç­–ç•¥å®šä¹‰é€»è¾‘
    const STRATS = [
        { name: "å¤§é˜³åè°ƒ", func: (d) => d[d.length-3].c >= d[d.length-3].o * 1.05 && d[d.length-2].c < d[d.length-2].o },
        { name: "é•¿å½±åè½¬", func: (d) => d[d.length-2].c >= d[d.length-2].o * 1.05 && d[d.length-3].o < d[d.length-2].c },
        { name: "ç¼©é‡å®‰å…¨", func: (d) => {
            const p2 = d[d.length-3], p1 = d[d.length-2];
            return p2.c >= p2.o * 1.05 && Math.abs(p1.c - p1.o) < (p1.h - p1.l) * 0.3 && p1.c < p1.o;
        }}
    ];

    const resBody = document.getElementById('resBody');
    const signalData = {}; // å­˜å‚¨æ‰€æœ‰å¸ç§çš„çŠ¶æ€

    // 2. å»ºç«‹å®æ—¶è¿æ¥
    const socket = new WebSocket('wss://fstream.binance.com/ws/!ticker@arr');

    socket.onmessage = async (event) => {
        const rawData = JSON.parse(event.data);
        const filtered = rawData.filter(item => item.s.endsWith('USDT') && parseFloat(item.P) >= 5);
        
        for (let s of filtered) {
            // å¦‚æœæ˜¯æ–°å‘ç°çš„å¸ç§ï¼Œå»æŠ“ K çº¿è·‘å›æµ‹
            if (!signalData[s.s]) {
                signalData[s.s] = { ...s, testing: true };
                runBacktest(s.s);
            } else {
                // æ›´æ–°ç°æœ‰å¸ç§çš„ä»·æ ¼
                signalData[s.s].c = s.c;
                signalData[s.s].P = s.P;
            }
        }
        renderTable();
    };

    // 3. æ ¸å¿ƒå›æµ‹å‡½æ•°ï¼ˆæŠŠä½ çš„ Python å›æµ‹ç¿»è¯‘æˆ JSï¼‰
    async function runBacktest(symbol) {
        try {
            // ä½¿ç”¨å…¬å…±ä¸­è½¬æŠ“å– 100 å¤© K çº¿
            const url = encodeURIComponent(`https://fapi.binance.com/fapi/v1/klines?symbol=${symbol}&interval=1d&limit=100`);
            const res = await fetch(CORS_PROXY + url);
            const klines = await res.json();
            const df = klines.map(k => ({ o: +k[1], h: +k[2], l: +k[3], c: +k[4] }));

            let hitStrats = [];
            let totalWinrate = 0;
            let totalProfit = 0;

            for (let strat of STRATS) {
                if (strat.func(df)) {
                    let trades = 0, wins = 0, p = 0;
                    // å›æµ‹è¿‡å» 100 å¤©
                    for (let j = 10; j < df.length - 1; j++) {
                        if (strat.func(df.slice(0, j + 1))) {
                            trades++;
                            const entry = df[j].o;
                            if (df[j+1].l <= entry * (1 - TP)) { wins++; p += (TP * INVEST * LEVERAGE); }
                            else { p += ((entry - df[j+1].c) / entry * INVEST * LEVERAGE); }
                        }
                    }
                    if (trades > 0) {
                        hitStrats.push(strat.name);
                        totalWinrate = (wins / trades * 100).toFixed(1);
                        totalProfit += p;
                    }
                }
            }

            if (hitStrats.length > 0) {
                signalData[symbol].strats = hitStrats;
                signalData[symbol].winrate = totalWinrate;
                signalData[symbol].profit = totalProfit.toFixed(2);
            } else {
                delete signalData[symbol]; // æ²¡å‘½ä¸­ç­–ç•¥çš„åˆ æ‰
            }
        } catch (e) { console.error(e); }
    }

    function renderTable() {
        const sorted = Object.values(signalData).filter(x => x.strats).sort((a,b) => b.P - a.P);
        if (sorted.length === 0) return;
        
        resBody.innerHTML = sorted.map(s => `
            <tr>
                <td><span class="symbol">${s.s}</span></td>
                <td>${s.strats.map(n => `<span class="strat-label">${n}</span>`).join('')}</td>
                <td>${parseFloat(s.c).toFixed(4)} / ${parseFloat(s.o).toFixed(4)}</td>
                <td class="winrate" style="color:var(--g-green)">+${s.P}%</td>
                <td class="winrate">${s.winrate}%</td>
                <td style="color:${s.profit >= 0 ? 'var(--g-green)' : 'var(--g-red)'}">${s.profit} USDT</td>
            </tr>
        `).join('');
    }
</script>
</body>
</html>
